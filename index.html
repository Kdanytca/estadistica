<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Análisis Estadístico Avanzado (Completo)</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- html2canvas + jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- SheetJS para Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #3498db;
            --bg: #f4f6fb;
            --card: #ffffff;
            --muted: #7f8c8d;
            --formula-red: #e74c3c;
        }

        body {
            font-family: Inter, Arial, sans-serif;
            margin: 20px;
            background: var(--bg);
            color: #263238;
        }

        .statistics-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 22px;
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(10, 20, 30, 0.06);
        }

        h2 {
            color: var(--primary);
            margin: 0 0 12px 0;
            font-size: 22px
        }

        .input-section {
            padding: 14px;
            border-radius: 10px;
            background: linear-gradient(90deg, #eef9ff, #ffffff);
            border: 1px solid rgba(52, 152, 219, 0.12);
            margin-bottom: 18px
        }

        .input-controls {
            display: flex;
            gap: 12px;
            align-items: center
        }

        select,
        textarea,
        input[type="text"] {
            font-size: 15px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #d0d7de;
            width: 100%;
            box-sizing: border-box
        }

        textarea {
            resize: vertical
        }

        button.btn {
            background: var(--primary);
            color: white;
            padding: 9px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer
        }

        button.secondary {
            background: white;
            border: 1px solid #d0d7de;
            color: var(--primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer
        }

        #dataStatus {
            margin-top: 8px;
            color: var(--muted)
        }

        .tab-controls-stats {
            display: flex;
            border-bottom: 2px solid #eef3f7;
            margin: 12px 0;
            gap: 6px
        }

        .tab-btn-stats {
            padding: 10px 14px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #4b5b62
        }

        .tab-btn-stats.active {
            color: var(--primary);
            font-weight: 600;
            border-bottom-color: var(--primary)
        }

        .tab-pane-stats {
            display: none;
            padding-top: 8px
        }

        .tab-pane-stats.active {
            display: block
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px
        }

        .card {
            background: #fbfdff;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #edf4fb
        }

        .card strong {
            display: block;
            margin-bottom: 6px
        }

        .formula {
            font-family: monospace;
            font-size: 0.9em;
            color: var(--formula-red);
            display: block;
            margin-top: 6px
        }

        #freqTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px
        }

        #freqTable th,
        #freqTable td {
            border: 1px solid #e9f1f8;
            padding: 8px;
            text-align: center
        }

        #freqTable th {
            background: var(--primary);
            color: white
        }

        #chartContainer {
            position: relative;
            height: 44vh;
            width: 100%;
            margin-top: 12px
        }

        .exports {
            display: flex;
            gap: 8px;
            margin-top: 12px
        }

        .detail {
            font-size: 0.9em;
            color: #444;
            margin-top: 6px;
            background: #fafafa;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #eee
        }

        @media(max-width:600px) {
            .input-controls {
                flex-direction: column;
                align-items: stretch
            }
        }
    </style>
</head>

<body>
    <div class="statistics-container">
        <h2>Análisis Estadístico Avanzado (Simple y Agrupado)</h2>

        <div class="input-section">
            <div class="input-controls">
                <label for="dataType">Tipo:</label>
                <select id="dataType" onchange="toggleInputMode()">
                    <option value="simple">Serie simple (no agrupada)</option>
                    <option value="grouped">Serie agrupada (intervalos)</option>
                </select>

                <button class="btn" onclick="procesarDatos()">Procesar y Calcular</button>

                <div style="margin-left:auto;display:flex;gap:8px">
                    <button class="secondary" onclick="limpiarTodo()">Limpiar</button>
                </div>
            </div>

            <div id="simpleInput" style="margin-top:12px">
                <label>Datos individuales (separados por coma):</label>
                <textarea id="dataInput" rows="3" placeholder="Ej: 2, 4, 4, 5, 7"></textarea>
            </div>

            <div id="groupedInput" style="margin-top:12px;display:none">
                <label>Intervalos (use formato Li-Ls, separados por coma):</label>
                <textarea id="intervalInput" rows="2" placeholder="Ej: 1-5, 6-10, 11-15"></textarea>
                <label style="margin-top:8px">Frecuencias (mismo orden, separadas por coma):</label>
                <textarea id="freqInput" rows="2" placeholder="Ej: 5, 8, 2"></textarea>
            </div>

            <p id="dataStatus"></p>
        </div>

        <div class="tab-controls-stats">
            <button class="tab-btn-stats active" data-tab="resumen" onclick="activateTab(event)">Resumen</button>
            <button class="tab-btn-stats" data-tab="dispersion" onclick="activateTab(event)">Dispersión</button>
            <button class="tab-btn-stats" data-tab="posicion" onclick="activateTab(event)">Posición</button>
            <button class="tab-btn-stats" data-tab="frecuencias" onclick="activateTab(event)">Frecuencias /
                Gráfica</button>
        </div>

        <div id="resumen" class="tab-pane-stats active">
            <div id="resumenResults" class="results-grid">
                <p>Ingresa datos y presiona <b>Procesar</b>.</p>
            </div>
        </div>

        <div id="dispersion" class="tab-pane-stats">
            <div id="dispersionResults" class="results-grid">
                <p>Ingresa datos y presiona <b>Procesar</b>.</p>
            </div>
        </div>

        <div id="posicion" class="tab-pane-stats">
            <div id="posicionResults" class="results-grid">
                <p>Ingresa datos y presiona <b>Procesar</b>.</p>
            </div>
        </div>

        <div id="frecuencias" class="tab-pane-stats">
            <div id="freqTableContainer" class="card">
                <p>La tabla aparecerá aquí.</p>
            </div>

            <div id="chartContainer" class="card">
                <canvas id="chartCanvas"></canvas>
            </div>

            <div class="exports">
                <button class="btn" onclick="exportToExcel()">Exportar Excel</button>
                <button class="btn" onclick="exportToPDF()">Exportar PDF</button>
            </div>
        </div>
    </div>

    <script>
        /* -------------------------
          Utiles y control de pestañas
        --------------------------*/
        function activateTab(e) {
            document.querySelectorAll('.tab-btn-stats').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane-stats').forEach(p => p.classList.remove('active'));
            e.currentTarget.classList.add('active');
            document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
        }
        function toggleInputMode() {
            const type = document.getElementById('dataType').value;
            document.getElementById('simpleInput').style.display = type === 'simple' ? 'block' : 'none';
            document.getElementById('groupedInput').style.display = type === 'grouped' ? 'block' : 'none';
            limpiarResultados();
        }
        function limpiarTodo() {
            document.getElementById('dataInput').value = '';
            document.getElementById('intervalInput').value = '';
            document.getElementById('freqInput').value = '';
            limpiarResultados();
        }
        function limpiarResultados() {
            document.getElementById('dataStatus').innerHTML = '';
            document.getElementById('resumenResults').innerHTML = '<p>Ingresa datos y presiona Procesar.</p>';
            document.getElementById('dispersionResults').innerHTML = '<p>Ingresa datos y presiona Procesar.</p>';
            document.getElementById('posicionResults').innerHTML = '<p>Ingresa datos y presiona Procesar.</p>';
            document.getElementById('freqTableContainer').innerHTML = '<p>La tabla aparecerá aquí.</p>';
            if (window.myChart) { window.myChart.destroy(); window.myChart = null; }
        }

        /* -------------------------
          Variables globales
        --------------------------*/
        window.myChart = null;

        /* =========================
          Procesar según modo
        =========================*/
        function procesarDatos() {
            const type = document.getElementById('dataType').value;
            if (type === 'simple') procesarSimple();
            else procesarAgrupado();
        }

        /* =========================
          Serie Simple (no agrupada)
        =========================*/
        function procesarSimple() {
            const raw = document.getElementById('dataInput').value.trim();
            if (!raw) { alert('Ingrese datos separados por comas'); return; }
            const arr = raw.split(',').map(s => parseFloat(s.trim())).filter(x => !isNaN(x)).sort((a, b) => a - b);
            if (arr.length === 0) { alert('No hay datos válidos'); return; }

            const n = arr.length;
            const suma = arr.reduce((s, x) => s + x, 0);
            const media = suma / n;
            // mediana
            let mediana = 0;
            if (n % 2 === 1) mediana = arr[(n - 1) / 2];
            else mediana = (arr[n / 2 - 1] + arr[n / 2]) / 2;
            // moda
            const freq = {};
            arr.forEach(v => freq[v] = (freq[v] || 0) + 1);
            const maxF = Math.max(...Object.values(freq));
            const modas = Object.keys(freq).filter(k => freq[k] === maxF).map(x => isFinite(parseFloat(x)) ? parseFloat(x) : x);
            const modaText = (maxF === 1) ? 'No hay moda clara' : modas.join(', ');
            // varianza poblacional
            const varP = arr.reduce((s, x) => s + Math.pow(x - media, 2), 0) / n;
            const sdP = Math.sqrt(varP);
            // cuartiles (interpolación simple: método (n+1) posicion)
            function percentile(p) {
                const pos = (p / 100) * (n + 1);
                if (pos <= 1) return arr[0];
                if (pos >= n) return arr[n - 1];
                const i = Math.floor(pos) - 1;
                const frac = pos - Math.floor(pos);
                return arr[i] + frac * (arr[i + 1] - arr[i]);
            }
            const q1 = percentile(25), q2 = percentile(50), q3 = percentile(75);

            // Mostrar (con fórmulas en rojo)
            document.getElementById('resumenResults').innerHTML = `
    <div class="card"><strong>Media (x̄)</strong>${media.toFixed(3)}
      <span class="formula">x̄ = Σx / n</span></div>
    <div class="card"><strong>Mediana (Me)</strong>${mediana}
      <span class="formula">Método (serie ordenada): valor central</span></div>
    <div class="card"><strong>Moda (Mo)</strong>${modaText}
      <span class="formula">Mo = valor con mayor frecuencia</span></div>
  `;
            document.getElementById('dispersionResults').innerHTML = `
    <div class="card"><strong>Varianza poblacional (σ²)</strong>${varP.toFixed(3)}
      <span class="formula">σ² = Σ(x - x̄)² / n</span></div>
    <div class="card"><strong>Desviación (σ)</strong>${sdP.toFixed(3)}
      <span class="formula">σ = √σ²</span></div>
  `;
            document.getElementById('posicionResults').innerHTML = `
    <div class="card"><strong>Q1</strong>${q1.toFixed(3)}<span class="formula">Q1: posición ≈ (n+1)/4</span></div>
    <div class="card"><strong>Q2 (Mediana)</strong>${q2.toFixed(3)}<span class="formula">Q2 = mediana</span></div>
    <div class="card"><strong>Q3</strong>${q3.toFixed(3)}<span class="formula">Q3: posición ≈ 3(n+1)/4</span></div>
  `;

            // Tabla de frecuencias simples y gráfico
            const unique = Object.keys(freq).sort((a, b) => parseFloat(a) - parseFloat(b));
            const values = unique.map(k => freq[k]);
            const labels = unique.map(k => k);

            renderChart(labels, values, unique.map((u, i) => values.slice(0, i + 1)));
            document.getElementById('freqTableContainer').innerHTML = `
    <h4>Frecuencias (serie simple)</h4>
    <table id="freqTable">
      <thead><tr><th>Valor</th><th>f</th></tr></thead>
      <tbody>
        ${labels.map((lab, i) => `<tr><td>${lab}</td><td>${values[i]}</td></tr>`).join('')}
      </tbody>
    </table>
  `;
            document.getElementById('dataStatus').innerHTML = `<span style="color:green">${n} datos procesados (simple)</span>`;
        }

        /* =========================
          Serie Agrupada (intervalos)
        =========================*/
        function procesarAgrupado() {
            const interRaw = document.getElementById('intervalInput').value.trim();
            const freqRaw = document.getElementById('freqInput').value.trim();
            if (!interRaw || !freqRaw) { alert('Ingrese intervalos y frecuencias'); return; }

            const intervalos = interRaw.split(',').map(s => s.trim()).filter(s => s !== '');
            const frecs = freqRaw.split(',').map(s => parseFloat(s.trim())).filter(x => !isNaN(x));

            if (intervalos.length !== frecs.length) { alert('Intervalos y frecuencias deben coincidir en cantidad'); return; }

            // Parsear clases
            const clases = intervalos.map(txt => {
                const partes = txt.split('-').map(p => p.trim());
                if (partes.length !== 2) throw Error('Formato de intervalo inválido: ' + txt);
                const li = parseFloat(partes[0]), ls = parseFloat(partes[1]);
                if (isNaN(li) || isNaN(ls)) throw Error('Límites no numéricos: ' + txt);
                return { li: Math.min(li, ls), ls: Math.max(li, ls) };
            });

            // verificar amplitudes (puede variar; para fórmulas asumimos i = ls - li de la clase modal o primera)
            const amplitudes = clases.map(c => c.ls - c.li);
            // Si no todas iguales, usamos i de la clase modal al calcular (esto es lo que suelen enseñar)
            const N = frecs.reduce((s, f) => s + f, 0);
            if (N === 0) { alert('N = 0'); return; }

            // puntos medios
            const pm = clases.map(c => +((c.li + c.ls) / 2).toFixed(6));

            // frecuencia acumulada (Fa)
            const Fa = [];
            frecs.reduce((acc, f, idx) => { const cur = acc + f; Fa[idx] = cur; return cur; }, 0);

            // media agrupada (x̄ = Σ(Pm*f) / N)
            const sumPf = pm.reduce((s, x, idx) => s + x * frecs[idx], 0);
            const media = sumPf / N;

            // varianza agrupada σ² = Σ[f * (Xm - x̄)²] / N
            const varianza = pm.reduce((s, x, idx) => s + frecs[idx] * Math.pow(x - media, 2), 0) / N;
            const desviacion = Math.sqrt(varianza);

            // -------------------------
            // Mediana agrupada (fórmula exacta del cuaderno)
            // Me = Li + ((N/2 - Fa_prev) / f_m) * i
            // -------------------------
            const mitad = N / 2;
            const idxMe = Fa.findIndex(v => v >= mitad);
            const idxMed = idxMe === -1 ? Fa.length - 1 : idxMe;
            const Li_me = clases[idxMed].li;
            const Fa_prev = idxMed === 0 ? 0 : Fa[idxMed - 1];
            const f_m = frecs[idxMed];
            const i_med = clases[idxMed].ls - clases[idxMed].li; // ancho de clase de la clase mediana
            const mediana = (f_m === 0 || i_med === 0) ? null : (Li_me + ((mitad - Fa_prev) / f_m) * i_med);

            // -------------------------
            // Moda agrupada (Pearson/interpolada)
            // Mo = Li + (d1/(d1+d2)) * i
            // d1 = f_modal - f_prev, d2 = f_modal - f_next
            // -------------------------
            const maxF = Math.max(...frecs);
            const idxModa = frecs.indexOf(maxF);
            const Li_mo = clases[idxModa].li;
            const f_prev = idxModa > 0 ? frecs[idxModa - 1] : 0;
            const f_modal = frecs[idxModa];
            const f_next = idxModa < frecs.length - 1 ? frecs[idxModa + 1] : 0;
            const d1 = f_modal - f_prev;
            const d2 = f_modal - f_next;
            const i_mo = clases[idxModa].ls - clases[idxModa].li;
            const moda = ((d1 + d2) === 0 || i_mo === 0) ? pm[idxModa] : (Li_mo + (d1 / (d1 + d2)) * i_mo);

            // -------------------------
            // Cuartiles agrupados (Qk = Li + ((kN/4 - Fa_prev) / f_k) * i)
            // -------------------------
            function cuartilAgrupado(k) {
                const pos = (k * N) / 4;
                const idx = Fa.findIndex(v => v >= pos);
                const idxq = idx === -1 ? Fa.length - 1 : idx;
                const Li_q = clases[idxq].li;
                const Fa_prev_q = idxq === 0 ? 0 : Fa[idxq - 1];
                const f_q = frecs[idxq];
                const i_q = clases[idxq].ls - clases[idxq].li;
                if (f_q === 0 || i_q === 0) return null;
                return Li_q + ((pos - Fa_prev_q) / f_q) * i_q;
            }
            const q1 = cuartilAgrupado(1);
            const q2 = cuartilAgrupado(2);
            const q3 = cuartilAgrupado(3);

            // -------------------------
            // Mostrar resultados con fórmulas (en rojo) y detalles numéricos
            // -------------------------
            // Resumen
            document.getElementById('resumenResults').innerHTML = `
    <div class="card"><strong>Media Agrupada (x̄)</strong>${isFinite(media) ? media.toFixed(3) : 'N/A'}
      <span class="formula">x̄ = Σ(Pm · f) / N</span></div>

    <div class="card"><strong>Mediana Agrupada (Me)</strong>${mediana !== null ? mediana.toFixed(3) : 'N/A'}
      <span class="formula">Me = Li + ((N/2 − Fa_prev) / f_m) · i</span>
    </div>

    <div class="card"><strong>Moda Agrupada (Mo)</strong>${isFinite(moda) ? (Number.isFinite(moda) ? moda.toFixed(3) : moda) : 'N/A'}
      <span class="formula">Mo = Li + ( d1 / (d1 + d2) ) · i</span>
    </div>
  `;

            // Dispersión
            document.getElementById('dispersionResults').innerHTML = `
    <div class="card"><strong>Varianza (agrupada)</strong>${isFinite(varianza) ? varianza.toFixed(3) : 'N/A'}
      <span class="formula">σ² = Σ[f · (Pm − x̄)²] / N</span></div>
    <div class="card"><strong>Desviación (σ)</strong>${isFinite(desviacion) ? desviacion.toFixed(3) : 'N/A'}
      <span class="formula">σ = √σ²</span></div>
  `;

            // Posición (cuartiles)
            document.getElementById('posicionResults').innerHTML = `
    <div class="card"><strong>Q1</strong>${q1 !== null ? q1.toFixed(3) : 'N/A'}
      <span class="formula">Q1 = Li + ((N/4 − Fa_prev) / f₁) · i</span></div>
    <div class="card"><strong>Q2 (Mediana)</strong>${q2 !== null ? q2.toFixed(3) : 'N/A'}
      <span class="formula">Q2 = Me (ver arriba)</span></div>
    <div class="card"><strong>Q3</strong>${q3 !== null ? q3.toFixed(3) : 'N/A'}
      <span class="formula">Q3 = Li + ((3N/4 − Fa_prev) / f₃) · i</span></div>
  `;

            // Tabla de frecuencias (mostrando Fa y Pm)
            let table = `<h4>Tabla de Frecuencias Agrupadas</h4>
    <table id="freqTable">
      <thead><tr><th>Clase (Li - Ls)</th><th>f</th><th>Fa</th><th>Punto medio (Xm)</th><th>fr %</th></tr></thead>
      <tbody>`;
            for (let idx = 0; idx < clases.length; idx++) {
                const c = clases[idx];
                const frp = (frecs[idx] / N) * 100;
                table += `<tr>
      <td>${c.li} - ${c.ls}</td>
      <td>${frecs[idx]}</td>
      <td>${Fa[idx]}</td>
      <td>${pm[idx]}</td>
      <td>${frp.toFixed(2)}%</td>
    </tr>`;
            }
            table += `</tbody>
    <tfoot><tr><td colspan="2"><strong>TOTAL</strong></td><td><strong>${N}</strong></td><td></td><td><strong>100%</strong></td></tr></tfoot>
    </table>`;
            document.getElementById('freqTableContainer').innerHTML = table;

            // Grafico (histograma + polígono + ojiva)
            // Usamos etiquetas como "Li-Ls" para el eje X; el polígono y la ojiva usan los mismos puntos.
            renderChart(clases.map(c => `${c.li}-${c.ls}`), frecs, Fa);
            document.getElementById('dataStatus').innerHTML = `<span style="color:green">${N} datos agrupados procesados.</span>`;
        }

        /* =========================
          Render Chart (bar + polygon + ojiva)
        =========================*/
        function renderChart(labels, freqs, fac) {
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            if (window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Frecuencia (f)',
                            data: freqs,
                            backgroundColor: 'rgba(52,152,219,0.75)',
                            borderColor: 'rgba(52,152,219,1)',
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            label: 'Polígono de frecuencia',
                            data: freqs,
                            borderColor: '#2c3e50',
                            tension: 0.25,
                            fill: false,
                            pointRadius: 4
                        },
                        {
                            type: 'line',
                            label: 'Ojiva (Frecuencia acumulada)',
                            data: fac,
                            borderColor: '#e74c3c',
                            borderDash: [6, 4],
                            tension: 0.25,
                            fill: false,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' } },
                        x: { title: { display: true, text: 'Clases' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Histograma con Polígono y Ojiva' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }

        /* =========================
          Exportar Excel (usa tabla #freqTable)
        =========================*/
        function exportToExcel() {
            const table = document.getElementById('freqTable');
            if (!table) { alert('No hay tabla para exportar'); return; }
            const wb = XLSX.utils.table_to_book(table, { sheet: "Frecuencias" });
            XLSX.writeFile(wb, "frecuencias.xlsx");
        }

        /* =========================
          Exportar PDF (captura contenedor principal)
        =========================*/
        async function exportToPDF() {
            const container = document.querySelector('.statistics-container');
            if (!container) { alert('No hay contenido'); return; }
            const canvas = await html2canvas(container, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth() - 20;
            const imgProps = pdf.getImageProperties(imgData);
            const height = (imgProps.height * pageWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 10, 10, pageWidth, height);
            pdf.save('reporte_estadistico.pdf');
        }
    </script>
</body>

</html>